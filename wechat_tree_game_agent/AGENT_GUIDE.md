# ğŸ¤– è‡ªåŠ¨ç©æ¸¸æˆ Agent ä½¿ç”¨æŒ‡å—

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹æˆ–è§„åˆ™ç­–ç•¥è‡ªåŠ¨ç©å¾®ä¿¡ç æ ‘æ¸¸æˆã€‚

---

## ğŸ¯ æ ¸å¿ƒå·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿æ¥è®¾å¤‡    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æˆªå–å±å¹•    â”‚ â†â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
       â”‚               â”‚
       â–¼               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  æ¨¡å‹æ¨ç†    â”‚        â”‚
â”‚ æˆ–è§„åˆ™å†³ç­–   â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
       â”‚               â”‚
       â–¼               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  æ‰§è¡ŒåŠ¨ä½œ    â”‚        â”‚
â”‚ (ç‚¹å‡»/æ›¿æ¢)  â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
       â”‚               â”‚
       â–¼               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  ç­‰å¾…å“åº”    â”‚ â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### Step 1: æµ‹è¯•è®¾å¤‡è¿æ¥

```bash
# ç¡®è®¤è®¾å¤‡å·²è¿æ¥
adb devices
# è¾“å‡º: 101.43.137.83:5555    device

# è¿è¡Œè¿æ¥æµ‹è¯•
python wechat_tree_game_agent/test_connection.py \
    --device 101.43.137.83:5555

# é¢„æœŸè¾“å‡º:
# âœ“ ADB è¿æ¥æˆåŠŸ
# âœ“ æˆªå›¾æˆåŠŸ
# âœ“ å±å¹•åˆ†è¾¨ç‡: 1080x2400
# âœ“ OCR è§£ææˆåŠŸ
```

### Step 2: æ‰“å¼€æ¸¸æˆ

**é‡è¦**: åœ¨è¿è¡Œ Agent ä¹‹å‰ï¼Œæ‰‹åŠ¨æ‰“å¼€æ¸¸æˆå¹¶è¿›å…¥ä¸»ç•Œé¢ï¼ˆç æ ‘ç•Œé¢ï¼‰

### Step 3: è¿è¡Œ Agentï¼ˆè§„åˆ™ç­–ç•¥ï¼‰

å¦‚æœè¿˜æ²¡æœ‰è®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œå¯ä»¥å…ˆä½¿ç”¨è§„åˆ™ç­–ç•¥æµ‹è¯•ï¼š

```bash
python wechat_tree_game_agent/play_game.py \
    --device 101.43.137.83:5555 \
    --debug \
    --max-steps 20
```

**å‚æ•°è¯´æ˜**:
- `--device`: Android è®¾å¤‡ ID
- `--debug`: å¼€å¯è°ƒè¯•æ¨¡å¼ï¼Œä¿å­˜æ¯æ­¥æˆªå›¾åˆ° `debug_screenshots/`
- `--max-steps`: æœ€å¤§æ­¥æ•°ï¼ˆé»˜è®¤ 50ï¼‰

### Step 4: è¿è¡Œ Agentï¼ˆæ¨¡å‹æ¨ç†ï¼‰

ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹ï¼š

```bash
python wechat_tree_game_agent/play_game.py \
    --device 101.43.137.83:5555 \
    --model /path/to/trained/model \
    --debug \
    --max-steps 20
```

---

## ğŸ“Š è¾“å‡ºç¤ºä¾‹

```
============================================================
å¼€å§‹æ¸¸æˆ Episode (æœ€å¤§æ­¥æ•°: 20)
============================================================

--- Step 1 ---
[1/4] æˆªå›¾å¹¶è§£ææ¸¸æˆçŠ¶æ€...
  çŠ¶æ€: tree_cutting
  å¦–åŠ›: 77925
[2/4] å†³ç­–ä¸‹ä¸€æ­¥åŠ¨ä½œ...
  åŠ¨ä½œ: click(540, 2000)
[3/4] æ‰§è¡ŒåŠ¨ä½œ...
âœ“ ç‚¹å‡»åæ ‡: (540, 2000)
[4/4] ç­‰å¾…æ¸¸æˆå“åº”...

--- Step 2 ---
[1/4] æˆªå›¾å¹¶è§£ææ¸¸æˆçŠ¶æ€...
  çŠ¶æ€: equipment_selection
  å¦–åŠ›: 77925
[2/4] å†³ç­–ä¸‹ä¸€æ­¥åŠ¨ä½œ...
  åŠ¨ä½œ: replace()
[3/4] æ‰§è¡ŒåŠ¨ä½œ...
[æ‰§è¡Œ] ç‚¹å‡»æ›¿æ¢æŒ‰é’®: (702, 1560)
âœ“ ç‚¹å‡»åæ ‡: (702, 1560)
[4/4] ç­‰å¾…æ¸¸æˆå“åº”...

...

============================================================
Episode æ€»ç»“
============================================================

æ€»æ­¥æ•°: 15
åˆå§‹å¦–åŠ›: 77925
æœ€ç»ˆå¦–åŠ›: 80450
å¦–åŠ›å¢é•¿: +2525

åŠ¨ä½œç»Ÿè®¡:
  click          :   8 æ¬¡
  decompose      :   2 æ¬¡
  replace        :   5 æ¬¡
============================================================
```

---

## ğŸ”§ å®Œæ•´å‚æ•°åˆ—è¡¨

```bash
python wechat_tree_game_agent/play_game.py --help
```

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--device` | str | `101.43.137.83:5555` | Android è®¾å¤‡ ID |
| `--model` | str | `None` | è®­ç»ƒå¥½çš„æ¨¡å‹è·¯å¾„ |
| `--max-steps` | int | `50` | å•å±€æœ€å¤§æ­¥æ•° |
| `--episodes` | int | `1` | è¿è¡Œå‡ å±€æ¸¸æˆ |
| `--no-ocr` | flag | `False` | ä¸ä½¿ç”¨ OCRï¼ˆä»…ä¾èµ–æ¨¡å‹ï¼‰ |
| `--debug` | flag | `False` | å¼€å¯è°ƒè¯•æ¨¡å¼ |

---

## ğŸ“‚ è°ƒè¯•æ¨¡å¼è¾“å‡º

å¼€å¯ `--debug` åï¼Œä¼šç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

```
debug_screenshots/
â”œâ”€â”€ step_001.png          # ç¬¬ 1 æ­¥æˆªå›¾
â”œâ”€â”€ step_002.png          # ç¬¬ 2 æ­¥æˆªå›¾
â”œâ”€â”€ ...
â””â”€â”€ action_history.json   # å®Œæ•´åŠ¨ä½œå†å²
```

**action_history.json æ ¼å¼**:
```json
[
  {
    "step": 1,
    "state": "tree_cutting",
    "action": "click(540, 2000)",
    "demon_power": 77925
  },
  {
    "step": 2,
    "state": "equipment_selection",
    "action": "replace()",
    "demon_power": 77925
  }
]
```

---

## ğŸ® å†³ç­–ç­–ç•¥

### è§„åˆ™ç­–ç•¥ï¼ˆä¸éœ€è¦æ¨¡å‹ï¼‰

**é€»è¾‘**:
1. **ç æ ‘ç•Œé¢** â†’ ç‚¹å‡»å±å¹•ä¸‹æ–¹ä¸­å¤®çš„æ–§å­
2. **è£…å¤‡ç•Œé¢**:
   - ä½¿ç”¨ OCR è¯†åˆ«è£…å¤‡å±æ€§å˜åŒ–
   - ä¼°ç®—å¦–åŠ›å˜åŒ– = Î£(å±æ€§å˜åŒ– Ã— æƒé‡)
   - å¦‚æœä¼°ç®—å€¼ > 0 â†’ `replace()`ï¼ˆæ›¿æ¢ï¼‰
   - å¦‚æœä¼°ç®—å€¼ â‰¤ 0 â†’ `decompose()`ï¼ˆåˆ†è§£ï¼‰

**æƒé‡è®¾ç½®** (è§ `game_state_parser.py:195-201`):
```python
weights = {
    "attack": 1.0,    # æ”»å‡»
    "defense": 0.8,   # é˜²å¾¡
    "hp": 0.5,        # ç”Ÿå‘½
    "speed": 0.3,     # æ•æ·
    "crit": 0.3,      # æš´å‡»
}
```

### æ¨¡å‹ç­–ç•¥ï¼ˆéœ€è¦è®­ç»ƒå¥½çš„æ¨¡å‹ï¼‰

**é€»è¾‘**:
1. å°†æˆªå›¾å’Œ prompt è¾“å…¥æ¨¡å‹
2. æ¨¡å‹è¾“å‡º: `<action>click(x, y)</action>` æˆ– `<action>replace()</action>`
3. è§£æåŠ¨ä½œå¹¶æ‰§è¡Œ

**Prompt æ ¼å¼**ï¼ˆè§ `format_prompt/tree_game_action.jinja`ï¼‰:
```
ä½ æ˜¯ä¸€ä¸ªå¾®ä¿¡å°ç¨‹åºç æ ‘æ¸¸æˆçš„æ™ºèƒ½åŠ©æ‰‹ï¼Œèƒ½å¤Ÿç†è§£æ¸¸æˆç•Œé¢å¹¶åšå‡ºæœ€ä¼˜å†³ç­–ã€‚

## æ¸¸æˆè§„åˆ™
1. æ¸¸æˆæœ€ä¸Šæ–¹é»„è‰²å­—ä½“æ˜¾ç¤º"å¦–åŠ›"æ•°å€¼ï¼Œè¿™æ˜¯ä½ éœ€è¦æœ€å¤§åŒ–çš„ç›®æ ‡
2. ç‚¹å‡»å±å¹•ä¸‹æ–¹æ­£ä¸­å¤®çš„"æ–§å­"å¯ä»¥è‡ªåŠ¨ç æ ‘
...
```

---

## ğŸ¯ åæ ‡è®¡ç®—

Agent ä¼šæ ¹æ®å±å¹•åˆ†è¾¨ç‡**åŠ¨æ€è®¡ç®—**æŒ‰é’®ä½ç½®ï¼š

### æ–§å­ä½ç½®ï¼ˆç æ ‘æŒ‰é’®ï¼‰

```python
x = screen_width // 2              # æ°´å¹³å±…ä¸­
y = int(screen_height * 5 / 6)    # å±å¹•ä¸‹æ–¹ 5/6 å¤„
```

**ç¤ºä¾‹**ï¼ˆ1080Ã—2400 åˆ†è¾¨ç‡ï¼‰:
- æ–§å­: `(540, 2000)`

### è£…å¤‡ç•Œé¢æŒ‰é’®

```python
# æ›¿æ¢æŒ‰é’®ï¼ˆç»¿è‰²ï¼Œå³ä¾§ï¼‰
replace_x = int(screen_width * 0.65)   # å³ä¾§ 65%
replace_y = int(screen_height * 0.65)  # å‚ç›´ä¸­å¤®åä¸‹

# åˆ†è§£æŒ‰é’®ï¼ˆçº¢è‰²ï¼Œå·¦ä¾§ï¼‰
decompose_x = int(screen_width * 0.35)  # å·¦ä¾§ 35%
decompose_y = int(screen_height * 0.65)
```

**ç¤ºä¾‹**ï¼ˆ1080Ã—2400 åˆ†è¾¨ç‡ï¼‰:
- æ›¿æ¢: `(702, 1560)`
- åˆ†è§£: `(378, 1560)`

**è°ƒæ•´æ–¹æ³•**:

å¦‚æœé»˜è®¤åæ ‡ä¸å‡†ç¡®ï¼Œä¿®æ”¹ `play_game.py`:
- æ–§å­ä½ç½®: ç¬¬ 68-75 è¡Œ `calculate_axe_position()`
- æŒ‰é’®ä½ç½®: ç¬¬ 77-93 è¡Œ `calculate_button_positions()`

---

## ğŸ” æ•…éšœæ’æŸ¥

### Q1: `âœ— ADB è¿æ¥å¤±è´¥`

**å¯èƒ½åŸå› **:
1. ADB æœªå®‰è£…æˆ–æœªæ·»åŠ åˆ° PATH
2. è®¾å¤‡æœªè¿æ¥
3. è®¾å¤‡ ID é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ ADB
adb version

# æ£€æŸ¥è®¾å¤‡åˆ—è¡¨
adb devices

# é‡å¯ ADB
adb kill-server
adb start-server

# é‡æ–°è¿æ¥è®¾å¤‡
adb connect 101.43.137.83:5555
```

### Q2: `âœ— æˆªå›¾å¤±è´¥`

**å¯èƒ½åŸå› **:
1. è®¾å¤‡æƒé™ä¸è¶³
2. è®¾å¤‡é”å±

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®è®¤è®¾å¤‡å·²è§£é”
- ç¡®è®¤ ADB æœ‰æˆªå›¾æƒé™

### Q3: `âš  OCR è§£æå¤±è´¥`

**å¯èƒ½åŸå› **:
- PaddleOCR æœªå®‰è£…

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å®‰è£… PaddleOCR
pip install paddleocr paddlepaddle

# æˆ–è€…è·³è¿‡ OCRï¼Œä»…ä½¿ç”¨æ¨¡å‹
python play_game.py --no-ocr
```

### Q4: ç‚¹å‡»ä½ç½®ä¸å‡†ç¡®

**è§£å†³æ–¹æ¡ˆ**:

1. **æŸ¥çœ‹è°ƒè¯•æˆªå›¾**:
   ```bash
   open debug_screenshots/step_001.png
   ```

2. **æ‰‹åŠ¨æµ‹é‡åæ ‡**:
   - ä½¿ç”¨å›¾ç‰‡æŸ¥çœ‹å™¨æŸ¥çœ‹æˆªå›¾
   - é¼ æ ‡ç§»åŠ¨åˆ°æŒ‰é’®ä½ç½®ï¼ŒæŸ¥çœ‹åæ ‡

3. **ä¿®æ”¹åæ ‡è®¡ç®—**:
   ç¼–è¾‘ `play_game.py`ï¼Œè°ƒæ•´åæ ‡è®¡ç®—å…¬å¼

### Q5: æ¨¡å‹æ¨ç†å¤±è´¥

**å¯èƒ½åŸå› **:
- æ¨¡å‹è·¯å¾„é”™è¯¯
- æ¨¡å‹æ ¼å¼ä¸å…¼å®¹

**è§£å†³æ–¹æ¡ˆ**:
```bash
# ä½¿ç”¨è§„åˆ™ç­–ç•¥ä»£æ›¿
python play_game.py --device 101.43.137.83:5555
# (ä¸æŒ‡å®š --model å‚æ•°)
```

---

## ğŸ§ª æµ‹è¯•å·¥å…·

### è¿æ¥æµ‹è¯•

```bash
python wechat_tree_game_agent/test_connection.py \
    --device 101.43.137.83:5555 \
    --test-tap
```

### å•æ­¥æµ‹è¯•

```python
# è¿›å…¥ Python äº¤äº’ç¯å¢ƒ
python

# å¯¼å…¥æ¨¡å—
from wechat_tree_game_agent.android_env import ADBController
from wechat_tree_game_agent.android_env import GameStateParser

# åˆå§‹åŒ–
controller = ADBController(device_id="101.43.137.83:5555")
parser = GameStateParser(use_gpu=False)

# æˆªå›¾
screenshot = controller.capture_screenshot(save_path="test.png")

# è§£æ
parsed = parser.parse_screenshot(screenshot)
print(parsed)

# ç‚¹å‡»
controller.tap(540, 2000)
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. è°ƒæ•´ç­‰å¾…æ—¶é—´

å¦‚æœæ¸¸æˆå“åº”æ…¢ï¼Œå¢åŠ ç­‰å¾…æ—¶é—´ï¼ˆ`play_game.py` ç¬¬ 309 è¡Œï¼‰:

```python
time.sleep(3.0)  # ä» 2.0 å¢åŠ åˆ° 3.0
```

### 2. å‡å°‘ OCR å¼€é”€

å¦‚æœæ¨¡å‹å·²ç»èƒ½å‡†ç¡®å†³ç­–ï¼Œå¯ä»¥ç¦ç”¨ OCRï¼š

```bash
python play_game.py --no-ocr --model /path/to/model
```

### 3. æ‰¹é‡è¿è¡Œ

è¿è¡Œå¤šå±€æ¸¸æˆï¼Œç»Ÿè®¡å¹³å‡æ€§èƒ½ï¼š

```bash
python play_game.py \
    --device 101.43.137.83:5555 \
    --episodes 10 \
    --max-steps 30
```

---

## ğŸ”„ æ¨¡å‹é›†æˆ

å¦‚æœä½ è®­ç»ƒäº†è‡ªå·±çš„æ¨¡å‹ï¼Œéœ€è¦ä¿®æ”¹ `play_game.py` ç¬¬ 60-78 è¡Œçš„ `_load_model()` æ–¹æ³•ã€‚

**ç¤ºä¾‹**ï¼ˆHuggingFace Transformersï¼‰:

```python
def _load_model(self, model_path: str):
    from transformers import AutoModelForVision2Seq, AutoProcessor

    processor = AutoProcessor.from_pretrained(model_path)
    model = AutoModelForVision2Seq.from_pretrained(
        model_path,
        device_map="auto",
        torch_dtype=torch.float16
    )

    return {"model": model, "processor": processor}
```

**ç¤ºä¾‹**ï¼ˆvLLMï¼‰:

```python
def _load_model(self, model_path: str):
    from vllm import LLM, SamplingParams

    llm = LLM(
        model=model_path,
        trust_remote_code=True,
        max_model_len=4096
    )

    return {
        "llm": llm,
        "sampling_params": SamplingParams(
            temperature=0.7,
            max_tokens=50
        )
    }
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **é¡¹ç›®æ€»è§ˆ**: `wechat_tree_game_agent/README.md`
- **æ•°æ®é›†æ–‡æ¡£**: `wechat_tree_game_agent/data/DATASET_SUMMARY.md`
- **è®­ç»ƒé…ç½®**: `wechat_tree_game_agent/config/tree_game_grpo.yaml`

---

**ç¥ä½ çš„ Agent è¡¨ç°å‡ºè‰²ï¼** ğŸ‰
